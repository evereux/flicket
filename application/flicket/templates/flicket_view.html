{% extends "flicket_base.html" %}
<!-- extend from base layout -->
{% block content %}
    <!-- {{ self._TemplateReference__context.name }} -->
    <div class="container">

        {% include 'flicket_apijson_users.html' %}

        <!-- flicket_view.html -->

        <!-- ticket details -->
        <div class="row m-2">
            <div class="col border rounded p-2 bg-white">
                <div class="row">
                    <div class="col-1 align-self-center text-center p-0">
                        {{ ticket.id_zfill }}
                    </div>
                    <div class="col flicket-ticket-title p-0">
                        {{ ticket.title }}
                    </div>
                    <div class="col-auto align-self-center">
                        <a class="btn btn-primary btn-sm flicket-button-link-white" role="button"
                                {%- if ticket.is_subscribed(g.user) -%}
                           href="{{ url_for('flicket_bp.unsubscribe_ticket', ticket_id = ticket.id) }}">
                                    {{ _('unsubscribe') }}
                                {%- else -%}
                                    href="{{ url_for('flicket_bp.subscribe_ticket', ticket_id = ticket.id) }}">
                                    {{ _('subscribe') }}
                                {%- endif -%}
                        </a>
                    </div>
                </div>

                <div class="row m-1">
                    <div class="col">
                        <div class="flicket-tickets-title">{{ _('Department') }}</div>
                        <div class="flicket-tickets-content">{{ ticket.category.department.department }}</div>
                    </div>
                    <div class="col">
                        <div class="flicket-tickets-title">{{ _('Category') }}</div>
                        <div class="flicket-tickets-content">{{ ticket.category.category }}</div>
                    </div>
                    <div class="col">
                        <div class="flicket-tickets-title">{{ _('Status') }}</div>
                        <div class="flicket-tickets-content">{{ ticket.current_status.status }}</div>
                    </div>
                    <div class="col">
                        <div class="flicket-tickets-title">{{ _('Priority') }}</div>
                        <div class="flicket-tickets-content {%- if ticket.current_status.status == 'Closed' %}
                                        flicket-status-closed{% endif %}
                                            {%- if ticket.ticket_priority.priority == 'high' %}
                                        flicket-status-high
                                            {% elif ticket.ticket_priority.priority == 'medium' %}
                                        flicket-status-medium
                                            {% elif ticket.ticket_priority.priority == 'low' %}
                                        flicket-status-low
                                            {% endif %}">{{ ticket.ticket_priority.priority }}</div>
                    </div>
                    <div class="col">
                        <div class="flicket-tickets-title">{{ _('Assigned') }}</div>
                        <div class="flicket-tickets-content">
                            {% if ticket.assigned.username %}
                                {{ ticket.assigned.name }}
                            {% else %}ticket not assigned{% endif %}
                        </div>
                    </div>
                    <div class="col-auto text-right pr-0">
                        <a class="btn btn-outline-primary btn-sm"
                           href="{{ url_for('flicket_bp.ticket_claim', ticket_id = ticket.id) }}">
                            {{ _('claim') }}
                        </a>

                        <a class="btn btn-outline-primary btn-sm"
                           href="{{ url_for('flicket_bp.release', ticket_id = ticket.id) }}">
                            {{ _('release') }}</a>

                        <a class="btn btn-outline-primary btn-sm"
                           href="{{ url_for('flicket_bp.ticket_assign', ticket_id = ticket.id) }}">
                            {{ _('assign') }}
                        </a>

                        <a class="btn btn-outline-primary btn-sm"
                           href="{{ url_for('flicket_bp.ticket_department_category', ticket_id = ticket.id) }}">
                            {{ _('category') }}
                        </a>
                    </div>
                </div>
            </div>
        </div>


        <!-- subscribers -->
        <div class="row m-2 border rounded p-2 bg-white">
            <div class="col align-self-center">
                Subscribed: {% for s in ticket.subscribers %}
                <a href="mailto:{{ s.user.email }}">{{ s.user.name }}</a>
                {%- if ticket.is_subscribed(g.user) and s.user == g.user -%}
                    &nbsp;<a style="color:red"
                             href="{{ url_for('flicket_bp.unsubscribe_ticket', ticket_id = ticket.id) }}"
                             title="unsubscribe">
                    <span class="oi oi-circle-x" aria-hidden="true"></span>
                </a>
                {%- endif -%} {{ ", " if not loop.last }}
            {% endfor %}
            </div>
            <form action=""
                  class="form form-inline"
                  enctype="multipart/form-data"
                  method="post"
                  name="subscribe_user">
                {{ form.hidden_tag() }}
                <div class="col">
                    {{ subscribers_form.username(class="form-control form-control-sm mr-1", id="autocomplete-username", placeholder="User Name") }}
                </div>
                <div class="col">
                    {{ subscribers_form.submit(class="btn btn-primary btn-sm") }}
                </div>
            </form>
        </div>

        <!-- pagination row -->
        <div class="row m-2">
            <div class="col">
                <ul class="pagination pagination-sm m-0">

                    <li class="page-item {% if not replies.has_prev -%} disabled {%- endif -%} ">
                        <a class="page-link"
                           href="{{ url_for('flicket_bp.ticket_view', ticket_id=ticket.id, page=replies.prev_num, **request.args) }}">
                            <<
                        </a>
                    </li>

                    {% for page in replies.iter_pages() %}
                        {%- if page -%}
                            {%- if page != replies.page -%}
                                <li class="page-item">
                                    <a class="page-link"
                                       href="{{ url_for('flicket_bp.ticket_view', ticket_id=ticket.id, page=page, **request.args) }}">
                                        {{ page }}
                                    </a>
                                </li>
                            {%- else -%}
                                <li class="page-item active">
                                    <a class="page-link"
                                       href="{{ url_for('flicket_bp.ticket_view', ticket_id=ticket.id, page=page, **request.args) }}">
                                        {{ page }}
                                    </a>
                                </li>
                            {%- endif -%}
                        {%- else -%}
                            <li class="page-item">
                                <a href="">...</a>
                            </li>
                        {%- endif -%}
                    {%- endfor -%}

                    <li class="page-item {% if not replies.has_next -%} disabled {%- endif -%} ">
                        <a class="page-link"
                           href="{{ url_for('flicket_bp.ticket_view', ticket_id=ticket.id, page=replies.next_num, **request.args) }}">
                            >>
                        </a>
                    </li>
                </ul>
            </div>
        </div>

        <!-- display ticket-->
        {{ display_post_box(ticket, page=page)|safe }}
        <!-- end display ticket -->

        <!-- display actions -->
        {% for action in ticket.actions_nonepost %}
            <div class="row m-3">
                <div class="col border rounded p-1 flicket-action">
                    {{ action.output_action()|safe }}
                </div>
            </div>
        {% endfor %}
        <!-- end display actions -->

        <!-- flicket ticket replies -->
        {% for r in replies.items %}
            <!-- display replies -->
            {{ display_post_box(ticket=ticket, post=r, replies=replies, loop=loop, page=page)|safe }}

            <!-- display actions -->
            {% for action in r.actions %}
                <div class="row m-3">
                    <div class="col border rounded p-1 flicket-action">
                        {{ action.output_action()|safe }}
                    </div>
                </div>
            {% endfor %}
            <!-- end display actions -->

        {% endfor %}

        {% include('flicket_form_reply.html') %}

    </div>
{% endblock %}
